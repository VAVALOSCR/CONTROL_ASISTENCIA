<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Control Biométrico</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
<style>
body{font-family:Arial;margin:20px;background:#f4f6f8}
button{padding:8px 14px;margin:4px;border:none;background:#1976d2;color:white;border-radius:6px;cursor:pointer}
button:hover{background:#125aa0}
table{border-collapse:collapse;width:100%;margin-top:15px;background:white}
th,td{border:1px solid #ccc;padding:6px;text-align:center}
th{background:#1976d2;color:white}
</style>
</head>
<body>
<h2>Control Biométrico</h2>
<input type="file" id="file" accept=".xlsx,.xls"><br><br>
<button onclick="verMarcaciones()">Ver Marcaciones</button>
<button onclick="resumen()">Resumen Tardanzas</button>
<button onclick="exportar()">Exportar por Persona</button>
<div id="tabla"></div>

<script>
let datos=[];
const HORARIO_ENTRADA="07:30";

function parseHoras(text){
 if(!text) return [];
 return text.toString().split(/\n|\r/).map(x=>x.trim()).filter(x=>/^\d{2}:\d{2}$/.test(x)).sort();
}

function minutosTarde(hora){
 if(!hora) return 0;
 const [h,m]=hora.split(":").map(Number);
 const ref=new Date(); ref.setHours(7,30,0,0);
 const ent=new Date(); ent.setHours(h,m,0,0);
 const diff=(ent-ref)/60000;
 return diff>0?Math.floor(diff):0;
}

document.getElementById('file').addEventListener('change',e=>{
 const reader=new FileReader();
 reader.onload=ev=>{
  const wb=XLSX.read(ev.target.result,{type:'binary'});
  const ws=wb.Sheets[wb.SheetNames[0]];
  datos=XLSX.utils.sheet_to_json(ws,{defval:""});
  alert("Archivo cargado");
 };
 reader.readAsBinaryString(e.target.files[0]);
});

function procesar(){
 let registros=[];
 if(datos.length===0) return registros;
 const columnas=Object.keys(datos[0]);
 const nombreCol=columnas[1];

 datos.forEach(row=>{
  const nombre=row[nombreCol];
  columnas.slice(3).forEach((col,i)=>{
   const horas=parseHoras(row[col]);
   if(!horas.length) return;
   const entrada=horas[0]||"";
   const salalm=horas[1]||"";
   const entalm=horas[2]||"";
   const salida=horas[3]||"";
   const tarde=minutosTarde(entrada);
   registros.push([nombre,i+1,entrada,salalm,entalm,salida,tarde]);
  });
 });
 return registros;
}

function pintar(headers,rows){
 let html="<table><tr>"+headers.map(h=>`<th>${h}</th>`).join("")+"</tr>";
 rows.forEach(r=>html+="<tr>"+r.map(c=>`<td>${c}</td>`).join("")+"</tr>");
 html+="</table>";
 document.getElementById('tabla').innerHTML=html;
}

function verMarcaciones(){
 const r=procesar();
 pintar(['Nombre','Dia','Entrada','Salida Alm','Entrada Alm','Salida','Min Tarde'],r);
}

function resumen(){
 const r=procesar();
 let total={};
 r.forEach(x=>{ total[x[0]]=(total[x[0]]||0)+x[6]; });
 const rows=Object.entries(total).sort().map(([k,v])=>[k,v]);
 pintar(['Nombre','Total minutos tarde'],rows);
}

function exportar(){
 const r=procesar();
 if(!r.length) return alert('No hay datos');
 let wb=XLSX.utils.book_new();
 let grupos={};
 r.forEach(x=>{ (grupos[x[0]]=grupos[x[0]]||[]).push(x); });
 Object.keys(grupos).forEach(nombre=>{
  let ws=XLSX.utils.aoa_to_sheet([
   ['Nombre','Dia','Entrada','Salida Alm','Entrada Alm','Salida','Min Tarde'],
   ...grupos[nombre]
  ]);
  XLSX.utils.book_append_sheet(wb,ws,nombre.substring(0,31));
 });
 XLSX.writeFile(wb,'reporte_biometrico.xlsx');
}
</script>
</body>
</html>
